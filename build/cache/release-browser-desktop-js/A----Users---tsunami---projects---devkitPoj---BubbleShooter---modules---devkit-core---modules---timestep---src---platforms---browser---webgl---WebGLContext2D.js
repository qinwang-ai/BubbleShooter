74c51a9c149ca1b30694c110e645022e
/*

 This file is part of the Game Closure SDK.

 The Game Closure SDK is free software: you can redistribute it and/or modify
 it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.

 The Game Closure SDK is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 Mozilla Public License v. 2.0 for more details.

 You should have received a copy of the Mozilla Public License v. 2.0
 along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.
*/
jsio("import device");jsio("import ui.resource.loader as loader");jsio("import ui.Color as Color");jsio("import .TextManager");jsio("import .Shaders");jsio("import .Matrix2D");jsio("import .WebGLTextureManager");
var ContextStateStack=__class__,ContextStateStack=ContextStateStack(function(){return this.init&&this.init.apply(this,arguments)},function(){this.init=function(){this._states=[this.getObject()];this._stateIndex=0};this.save=function(){var a=this.state;++this._stateIndex>=this._states.length&&(this._states[this._stateIndex]=this.getObject());var b=this.state;b.globalCompositeOperation=a.globalCompositeOperation;b.globalAlpha=a.globalAlpha;b.transform.copy(a.transform);b.textBaseLine=a.textBaseLine;
b.lineWidth=a.lineWidth;b.strokeStyle=a.strokeStyle;b.fillStyle=a.fillStyle;b.filter=a.filter;b.clip=a.clip;b.clipRect.x=a.clipRect.x;b.clipRect.y=a.clipRect.y;b.clipRect.width=a.clipRect.width;b.clipRect.height=a.clipRect.height};this.restore=function(){0<this._stateIndex&&this._stateIndex--};this.getObject=function(){return{globalCompositeOperation:"source-over",globalAlpha:1,transform:new Matrix2D,lineWidth:1,filter:null,clip:!1,clipRect:{x:0,y:0,width:0,height:0},fillStyle:"",strokeStyle:""}};
Object.defineProperty(this,"state",{get:function(){return this._states[this._stateIndex]}});Object.defineProperty(this,"parentState",{get:function(){return 0<this._stateIndex?this._states[this._stateIndex-1]:null}})}),STRIDE=24,RENDER_MODES={Default:0,LinearAdd:1,Tint:2,Multiply:3,Rect:4,PositiveMask:0,NegativeMask:0},COLOR_MAP={},getColor=function(a){var b=COLOR_MAP[a];b||(b=COLOR_MAP[a]=Color.parse(a));return b},GLManager=__class__,GLManager=GLManager(function(){return this.init&&this.init.apply(this,
arguments)},function(){this.init=function(){var a=!1;try{var b=document.createElement("canvas"),a=!(!window.WebGLRenderingContext||!b.getContext("webgl"))}catch(c){}this.width=device.screen.width;this.height=device.screen.height;if(this.isSupported=a&&CONFIG.useWebGL){this.textManager=new TextManager;this.textureManager=new WebGLTextureManager;this.textureManager.on(WebGLTextureManager.TEXTURE_REMOVED,bind(this,function(){this.flush()}));this._helperTransform=new Matrix2D;this._canvas=document.createElement("canvas");
this._canvas.width=this.width;this._canvas.height=this.height;this._canvas.getWebGLContext=this._canvas.getContext.bind(this._canvas,"webgl",{alpha:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!0});this._indexCache=new Uint16Array(3072);this._vertexCache=new ArrayBuffer(2048*STRIDE);this._vertices=new Float32Array(this._vertexCache);this._colors=new Uint8Array(this._vertexCache);for(b=a=0;3072>a;a+=6,b+=4)this._indexCache[a]=b,this._indexCache[a+1]=b+2,this._indexCache[a+2]=b+3,this._indexCache[a+
3]=b,this._indexCache[a+4]=b+3,this._indexCache[a+5]=b+1;this._batchQueue=Array(512);for(a=0;512>=a;a++)this._batchQueue[a]={textureId:0,index:0,clip:!1,filter:null,clipRect:{x:0,y:0,width:0,height:0},renderMode:0};this.contexts=[];this.initGL();this._primaryContext=new Context2D(this,this._canvas);this.activate(this._primaryContext);loader.on(loader.IMAGE_LOADED,function(a){this.createOrUpdateTexture(a,a.__GL_ID,!0)}.bind(this));this.contextActive=!0;this._canvas.addEventListener("webglcontextlost",
this.handleContextLost.bind(this),!1);this._canvas.addEventListener("webglcontextrestored",this.handleContextRestored.bind(this),!1)}};this.handleContextLost=function(a){a.preventDefault();this.contextActive=!1;this.gl=null};this.handleContextRestored=function(){this.initGL();this.contextActive=!0};this.initGL=function(){var a=this.gl=this._canvas.getWebGLContext();a.clearColor(0,0,0,0);a.disable(a.DEPTH_TEST);a.disable(a.CULL_FACE);a.enable(a.BLEND);a.blendEquation(a.FUNC_ADD);a.activeTexture(a.TEXTURE0);
this._scissorEnabled=!1;this._activeScissor={x:0,y:0,width:0,height:0};this._activeCompositeOperation="";this.setActiveCompositeOperation("source-over");this._activeRenderMode=-1;this._activeShader=null;a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);this._batchIndex=this._drawIndex=-1;this._indexBuffer=a.createBuffer();this._vertexBuffer=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this._indexBuffer);a.bufferData(a.ELEMENT_ARRAY_BUFFER,this._indexCache,a.STATIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,
this._vertexBuffer);a.bufferData(a.ARRAY_BUFFER,this._vertexCache,a.DYNAMIC_DRAW);this.shaders=[];this.shaders[RENDER_MODES.Default]=new Shaders.DefaultShader({gl:a});this.shaders[RENDER_MODES.LinearAdd]=new Shaders.LinearAddShader({gl:a});this.shaders[RENDER_MODES.Tint]=new Shaders.TintShader({gl:a});this.shaders[RENDER_MODES.Multiply]=new Shaders.MultiplyShader({gl:a});this.shaders[RENDER_MODES.Rect]=new Shaders.RectShader({gl:a});this.textureManager.initGL(a);this.updateContexts()};this.updateContexts=
function(){for(var a=0;a<this.contexts.length;a++)this.contexts[a].createOffscreenFrameBuffer()};this.updateCanvasDimensions=function(){this._primaryContext.resize(this._canvas.width,this._canvas.height)};this.getContext=function(a,b){var b=b||{},c;!1===b.offscreen?(c=this._primaryContext,c.resize(b.width,b.height)):(c=new Context2D(this,a),c.createOffscreenFrameBuffer(),this.contexts.push(c));return c};this.setActiveRenderMode=function(a){if(this._activeRenderMode!==a&&this.gl){var b=this._activeCtx;
this._activeRenderMode=a;a=this.shaders[a];this._activeShader&&this._activeShader!==a&&this._activeShader.disableVertexAttribArrays();this._activeShader=a;gl.useProgram(a.program);a.enableVertexAttribArrays();gl.uniform2f(a.uniforms.uResolution,b.width,b.height);-1!==a.uniforms.uSampler&&gl.uniform1i(a.uniforms.uSampler,0)}};this.setActiveCompositeOperation=function(a){a=a||"source-over";if(this._activeCompositeOperation!==a&&this.gl){this._activeCompositeOperation=a;var b=this.gl,c;switch(a){case "source-over":a=
b.ONE;c=b.ONE_MINUS_SRC_ALPHA;break;case "source-atop":a=b.DST_ALPHA;c=b.ONE_MINUS_SRC_ALPHA;break;case "source-in":a=b.DST_ALPHA;c=b.ZERO;break;case "source-out":a=b.ONE_MINUS_DST_ALPHA;c=b.ZERO;break;case "destination-atop":a=b.DST_ALPHA;c=b.SRC_ALPHA;break;case "destination-in":a=b.ZERO;c=b.SRC_ALPHA;break;case "destination-out":c=a=b.ONE_MINUS_SRC_ALPHA;break;case "destination-over":a=b.DST_ALPHA;c=b.SRC_ALPHA;break;case "lighter":c=a=b.ONE;break;case "xor":case "copy":a=b.ONE;c=b.ONE_MINUS_SRC_ALPHA;
break;default:a=b.ONE,c=b.ONE_MINUS_SRC_ALPHA}b.blendFunc(a,c)}};this.flush=function(){if(-1!==this._batchIndex&&this.gl){var a=this.gl;a.bufferSubData(a.ARRAY_BUFFER,0,this._vertexCache);this._batchQueue[this._batchIndex+1].index=this._drawIndex+1;for(var b=0;b<=this._batchIndex;b++){var c=this._batchQueue[b];if(c.clip){var i=c.clipRect;this.enableScissor(i.x,i.y,i.width,i.height)}else this.disableScissor();i=c.textureId;if(-1!==i){i=this.textureManager.getTexture(i);if(!i)continue;a.bindTexture(a.TEXTURE_2D,
i)}this.setActiveCompositeOperation(c.globalCompositeOperation);this.setActiveRenderMode(c.renderMode);c=c.index;a.drawElements(a.TRIANGLES,6*(this._batchQueue[b+1].index-c),a.UNSIGNED_SHORT,12*c)}this._batchIndex=this._drawIndex=-1}};this.createOrUpdateTexture=function(a,b,c){if(!this.gl)return-1;b=this.textureManager.createOrUpdateTexture(a,b);c&&(c=this._primaryContext.globalAlpha,this._primaryContext.globalAlpha=1.0E-5,this._primaryContext.drawImage(a,0,0,1,1,0,0,1,1),this.flush(),this._primaryContext.globalAlpha=
c);return b};this.getTexture=function(a){return this.textureManager.getTexture(a)};this.deleteTexture=function(a){this.textureManager.deleteTexture(a)};this.deleteTextureForImage=function(a){this.textureManager.deleteTextureForImage(a)};this.enableScissor=function(a,b,c,i){if(this.gl){var o=this.gl;this._scissorEnabled||(o.enable(o.SCISSOR_TEST),this._scissorEnabled=!0);var j=this._activeScissor,b=this._activeCtx.height-i-b;if(a!==j.x||b!==j.y||c!==j.width||i!==j.height)j.x=a,j.y=b,j.width=c,j.height=
i,o.scissor(a,b,c,i)}};this.disableScissor=function(){if(this.gl&&this._scissorEnabled){var a=this.gl;this._scissorEnabled=!1;a.disable(a.SCISSOR_TEST)}};this.addToBatch=function(a,b){511<=this._drawIndex&&this.flush();this._drawIndex++;var c=a.filter,i=a.clip,o=a.clipRect,j=-1<this._batchIndex?this._batchQueue[this._batchIndex]:null;if(!j||j.textureId!==b||-1===b&&j.fillStyle!==a.fillStyle||j.globalCompositeOperation!==a.globalCompositeOperation||j.filter!==c||j.clip!==i||j.clipRect.x!==o.x||j.clipRect.y!==
o.y||j.clipRect.width!==o.width||j.clipRect.height!==o.height)j=this._batchQueue[++this._batchIndex],j.textureId=b,j.index=this._drawIndex,j.globalCompositeOperation=a.globalCompositeOperation,j.filter=c,j.clip=i,j.clipRect.x=o.x,j.clipRect.y=o.y,j.clipRect.width=o.width,j.clipRect.height=o.height,j.renderMode=-1===b?RENDER_MODES.Rect:c?RENDER_MODES[c.getType()]:RENDER_MODES.Default;return this._drawIndex};this.isPowerOfTwo=function(a,b){return 0<a&&0===(a&a-1)&&0<b&&0===(b&b-1)};this.activate=function(a,
b){var c=this.gl,i=a===this._activeCtx;if(!i||b)i||(this.flush(),c.finish(),this._activeCtx=a),c.bindFramebuffer(c.FRAMEBUFFER,a.frameBuffer),c.viewport(0,0,a.width,a.height),this._activeRenderMode=-1}}),textCtx=document.createElement("canvas").getContext("2d"),Context2D=__class__,Context2D=Context2D(function(){return this.init&&this.init.apply(this,arguments)},function(){this._helperTransform=new Matrix2D;for(var a=function(a,b){Object.defineProperty(a,b,{get:function(){return this.stack.state[b]},
set:function(a){this.stack.state[b]=a}})},b="globalAlpha globalCompositeOperation textBaseLine lineWidth strokeStyle fillStyle font".split(" "),c=0;c<b.length;c++)a(this,b[c]);this.init=function(a,b){this._manager=a;this.canvas=b;this.width=b.width;this.height=b.height;this.stack=new ContextStateStack;this.font="11px "+device.defaultFontFamily;this.filter=this.frameBuffer=null};this.createOffscreenFrameBuffer=function(){var a=this._manager.gl;if(a){var b=this._manager._activeCtx;this._texture=this._manager.getTexture(this._manager.createOrUpdateTexture(this.canvas));
this.frameBuffer=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,this.frameBuffer);a.bindTexture(a.TEXTURE_2D,this._texture);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this._texture,0);this.canvas.__glFlip=!0;this._manager.activate(b,!0)}};var i=Math.min,o=Math.max;this.loadIdentity=function(){this.stack.state.transform.identity()};this.setTransform=function(a,b,n,f,e,d){this.stack.state.transform.setTo(a,b,n,f,e,d)};this.transform=function(a,b,n,f,e,d){this._helperTransform.setTo(a,
b,n,f,e,d);this.stack.state.transform.transform(this._helperTransform)};this.scale=function(a,b){this.stack.state.transform.scale(a,b)};this.translate=function(a,b){this.stack.state.transform.translate(a,b)};this.rotate=function(a){this.stack.state.transform.rotate(a)};this.getElement=function(){return this.canvas};this.reset=function(){};this.clear=function(){this._manager.activate(this);this._manager.flush();this._manager.disableScissor();var a=this._manager.gl;a&&a.clear(a.COLOR_BUFFER_BIT)};this.resize=
function(a,b){this.width=a;this.height=b;this.canvas instanceof HTMLCanvasElement&&(this.canvas.width=a,this.canvas.height=b);this._manager.activate(this,!0);if(this._texture&&this._manager.gl){var n=this._manager.gl;n.bindTexture(n.TEXTURE_2D,this._texture);n.texImage2D(n.TEXTURE_2D,0,n.RGBA,a,b,0,n.RGBA,n.UNSIGNED_BYTE,null)}};this.clipRect=function(a,b,n,f){var e=this.stack.state.transform,d=a+n,c=b+f,n=a*e.a+b*e.c+e.tx,f=a*e.b+b*e.d+e.ty,p=d*e.a+b*e.c+e.tx,b=d*e.b+b*e.d+e.ty,w=a*e.a+c*e.c+e.tx,
a=a*e.b+c*e.d+e.ty,r=d*e.a+c*e.c+e.tx,e=d*e.b+c*e.d+e.ty,q,l,g=(d=this.stack.parentState)&&d.clip&&d.clipRect;g?(d=g.x,q=g.y,c=g.x+g.width,l=g.y+g.height):(q=d=0,c=this.width,l=this.height);g=i(c,n,p,w,r);n=o(d,n,p,w,r);p=i(l,f,b,a,e);f=o(q,f,b,a,e);g<d&&(g=d);n>c&&(n=c);p<q&&(p=q);f>l&&(f=l);this.stack.state.clip=!0;b=this.stack.state.clipRect;b.x=g;b.y=p;b.width=n-g;b.height=f-p};this.swap=function(){this._manager.flush()};this.execSwap=function(){};this.setFilter=function(a){this.filter=this.stack.state.filter=
a};this.setFilters=function(a){logger.WARN&&console.warn("WARN",".webgl.WebGLContext2D","ctx.setFilters is deprecated, use ctx.setFilter instead.");for(var b in a){this.setFilter(a[b]);return}this.clearFilter()};this.clearFilter=function(){this.filter=this.stack.state.filter=null};this.clearFilters=function(){logger.WARN&&console.warn("WARN",".webgl.WebGLContext2D","ctx.clearFilters is deprecated, use ctx.clearFilter instead.");this.clearFilter()};this.save=function(){this.stack.save()};this.restore=
function(){this.stack.restore()};this.circle=function(){};this.drawPointSprites=function(){};this.roundRect=function(){};this.fillText=function(a,b,n){if(this._manager.gl&&(a=this._manager.textManager.get(this,a,!1))){var c=a.image.width,e=a.image.height;this.drawImage(a.image,0,0,c,e,b,n,c,e)}};this.strokeText=function(a,b,c){if(this._manager.gl&&(a=this._manager.textManager.get(this,a,!0))){var f=a.image.width,e=a.image.height;this.drawImage(a.image,0,0,f,e,b-0.5*this.lineWidth,c-0.5*this.lineWidth,
f,e)}};this.measureText=function(a){textCtx.font=this.font;return textCtx.measureText(a)};this.drawImage=function(a,b,c,f,e,d,h,p,w){if(this._manager.gl){var r=!!a.__glFlip,q=this.stack.state,l=q.globalAlpha;if(0!==l){var g=this._manager;g.activate(this);var x=a.__GL_ID;if(void 0===x||a.__needsUpload){if(0===a.width||0===a.height||!a.complete)return;a.__needsUpload=!1;x=g.createOrUpdateTexture(a,x)}var x=g.addToBatch(this.stack.state,x),m=a.width,k=a.height,a=q.transform,u=b+f,s=c+e,v=d+p,t=h+w;r&&
(c=k-c,s=c-e);if(0>b||u>m||0>c||s>k)var r=o(0,b),z=o(0,c),y=i(u,m),A=i(s,k),f=p/f,e=w/e,d=d+(r-b)*f,v=v-(u-y)*f,h=h+(z-c)*e,t=t-(s-A)*e,b=r,c=z,u=y,s=A;e=d*a.b+h*a.d+a.ty;w=v*a.a+h*a.c+a.tx;f=v*a.b+h*a.d+a.ty;p=d*a.a+t*a.c+a.tx;r=d*a.b+t*a.d+a.ty;z=v*a.a+t*a.c+a.tx;v=v*a.b+t*a.d+a.ty;y=1/m;t=1/k;m=g._vertices;k=24*x;b*=y;u*=y;c*=t;s*=t;m[k+0]=d*a.a+h*a.c+a.tx;m[k+1]=e;m[k+2]=b;m[k+3]=c;m[k+4]=l;m[k+6]=w;m[k+7]=f;m[k+8]=u;m[k+9]=c;m[k+10]=l;m[k+12]=p;m[k+13]=r;m[k+14]=b;m[k+15]=s;m[k+16]=l;m[k+18]=
z;m[k+19]=v;m[k+20]=u;m[k+21]=s;m[k+22]=l;q.filter&&(d=q.filter.get(),h=4*x*STRIDE,g=g._colors,g[h+20]=g[h+44]=g[h+68]=g[h+92]=d.r,g[h+21]=g[h+45]=g[h+69]=g[h+93]=d.g,g[h+22]=g[h+46]=g[h+70]=g[h+94]=d.b,g[h+23]=g[h+47]=g[h+71]=g[h+95]=255*d.a)}}};this.fillRect=function(a,b,c,f){0!==this.globalAlpha&&this._fillRect(a,b,c,f,getColor(this.stack.state.fillStyle))};this.strokeRect=function(a,b,c,f){var e=this.stack.state.lineWidth,d=e/2,h=getColor(this.stack.state.strokeStyle);this._fillRect(a+d,b-d,c-
e,e,h);this._fillRect(a+d,b+f-d,c-e,e,h);this._fillRect(a-d,b-d,e,f+e,h);this._fillRect(a+c-d,b-d,e,f+e,h)};this._fillRect=function(a,b,c,f,e){var d=this.stack.state.transform,h=a+c,i=b+f,f=a*d.a+b*d.c+d.tx,c=a*d.b+b*d.d+d.ty,o=h*d.a+b*d.c+d.tx,b=h*d.b+b*d.d+d.ty,r=a*d.a+i*d.c+d.tx,a=a*d.b+i*d.d+d.ty,q=h*d.a+i*d.c+d.tx,h=h*d.b+i*d.d+d.ty,d=this._manager;d.activate(this);var i=d.addToBatch(this.stack.state,-1),l=d._vertices,g=24*i;l[g+0]=f;l[g+1]=c;l[g+4]=this.globalAlpha;l[g+6]=o;l[g+7]=b;l[g+10]=
this.globalAlpha;l[g+12]=r;l[g+13]=a;l[g+16]=this.globalAlpha;l[g+18]=q;l[g+19]=h;l[g+22]=this.globalAlpha;f=4*i*STRIDE;c=d._colors;c[f+20]=c[f+44]=c[f+68]=c[f+92]=e.r;c[f+21]=c[f+45]=c[f+69]=c[f+93]=e.g;c[f+22]=c[f+46]=c[f+70]=c[f+94]=e.b;c[f+23]=c[f+47]=c[f+71]=c[f+95]=255*e.a};this.deleteTextureForImage=function(a){this._manager.deleteTextureForImage(a)}});exports=new GLManager;
