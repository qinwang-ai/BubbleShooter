7f8f3cc42e22d8a912a45a38746a9e82
jsio("import std.uri as URI");exports.MAX_SIMULTANEOUS=4;var _inflight=0,doc;exports.getDoc=function(){if(doc)return doc;try{if(doc=window.ActiveXObject&&new ActiveXObject("htmlfile"))doc.open().write("<html></html>"),doc.close(),window.attachEvent("onunload",function(){try{doc.body.innerHTML=""}catch(a){}doc=null})}catch(b){}doc||(doc=document);return doc};
var ctor=function(){var b=window;exports.getDoc();return new (ctor=b.XMLHttpRequest?b.XMLHttpRequest:function(){return b.ActiveXObject&&new b.ActiveXObject("Msxml2.XMLHTTP")||null})};exports.createXHR=function(){return new ctor};exports.post=function(b,a){return exports.get(merge({method:"POST"},b),a)};
var Request=__class__,Request=Request(function(){return this.init&&this.init.apply(this,arguments)},function(){var b=0;this.init=function(a,c){"string"==typeof a&&(a={url:a});if(!a||!a.url)logger.ERROR&&console.error("ERROR","util.ajax","no url provided");else{this.method=(a.method||"GET").toUpperCase();this.url=a.url;this.type=a.type;this.async=a.async;this.timeout=a.timeout;this.withCredentials=!!a.withCredentials;this.id=++b;this.headers={};this.cb=c;if(a.headers)for(var d in a.headers)a.headers.hasOwnProperty(d)&&
(this.headers[d]=a.headers[d]);d=a.data&&"object"==typeof a.data;"GET"==this.method&&a.data&&(this.url=(new URI(this.url)).addQuery(d?a.data:URI.parseQuery(a.data)).toString());a.query&&(this.url=(new URI(this.url)).addQuery("object"==typeof a.query?a.query:URI.parseQuery(a.query)).toString());try{this.data="GET"!=this.method?d?JSON.stringify(a.data):a.data:null,d&&!this.headers["Content-Type"]&&(this.headers["Content-Type"]="application/json")}catch(e){c&&c({invalidData:!0},null,"")}}}}),_pending=
[];exports.get=function(b,a){var c=new Request(b,a);_inflight>=exports.MAX_SIMULTANEOUS?_pending.push(c):_send(c)};function _sendNext(){if(_inflight<exports.MAX_SIMULTANEOUS){var b=_pending.shift();b&&_send(b)}}
function _send(b){++_inflight;var a=exports.createXHR();a.open(b.method,b.url,!1!=b.async);var c=!1,d;for(d in b.headers)"content-type"==d.toLowerCase()&&(c=!0),a.setRequestHeader(d,b.headers[d]);a.withCredentials=b.withCredentials;c||a.setRequestHeader("Content-Type","text/plain");a.onreadystatechange=bind(this,onReadyStateChange,b,a);b.timeout&&(b.timeoutRef=setTimeout(bind(this,cancel,a,b),b.timeout));b.ts=+new Date;a.send(b.data||null)}
function cancel(b,a){--_inflight;a.timedOut&&logger.LOG&&console.log("LOG","util.ajax","already timed out?!");b.onreadystatechange=null;a.timedOut=!0;if(b.readyState>=b.HEADERS_RECEIVED)try{var c=b.getAllResponseHeaders()}catch(d){}a.cb&&a.cb({timeout:!0},null,c)}
function onReadyStateChange(b,a){if(4==a.readyState){if(b.timedOut)throw"Unexpected?!";--_inflight;setTimeout(_sendNext,0);var c=b.cb;"timeoutRef"in b&&(clearTimeout(b.timeoutRef),b.timeoutRef=null);if(c&&!b.handled){b.handled=!0;var d=/^application\/json(;|$)/.test(a.getResponseHeader("Content-Type"))||"json"==b.type,e=a.response||a.responseText,f=e,g=!1;if(d&&e&&"string"==typeof e)try{f=JSON.parse(e)}catch(h){g=!0}200!=a.status&&0!=a.status||g?c({status:a.status,response:f,parseError:g},null,a.getAllResponseHeaders()):
c(null,f,a.getAllResponseHeaders())}}};
