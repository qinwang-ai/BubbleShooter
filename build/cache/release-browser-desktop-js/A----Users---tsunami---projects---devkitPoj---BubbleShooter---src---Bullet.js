74773cc6acb9a60f1397a645a4c7414a
jsio("import ui.ImageView");jsio("import math.geom.Point as Point");jsio("import animate");jsio("import src.Config as config");jsio("import src.SoundController as Sound");jsio("import ui.ParticleEngine as ParticleEngine");var Users_tsunami_projects_devkitPoj_BubbleShooter_src_Bullet=__class__;
exports=Users_tsunami_projects_devkitPoj_BubbleShooter_src_Bullet(function(){return this.init&&this.init.apply(this,arguments)},ui.ImageView,function(i){this.init=function(a){a=merge(a,{x:165,y:450,width:2*r,height:2*r,offsetX:-r,offsetY:-r,image:types[0],type:0});i(this,"init",[a]);this._deviceWidth=GLOBAL.SCREEN_SIZE.width;this._magnLength=config.bulletMagnLength;this._delay=config.bulletSpeedDelay;this._sound=Sound.getSound();this._origin=new Point(this.style.x,this.style.y);this._type=a.type;
this._hit=!1;this._edges=[];this._pEngine=new ParticleEngine({superview:this});this.build()};this.build=function(){var a,b=this._deviceWidth,c=this._delay;this._animate=animate(this);this.on("bullet:launch",bind(this,function(b){this._isLoaded?(a=this.magnitudeLength(b),this._sound.play("lightning"),this._animate.now({x:a.x,y:a.y},c,animate.linear),this._isLoaded=!1):console.error("Bullet.build : bullet not loaded")}));this.on("bullet:touchLeftWall",bind(this,function(){0>a.x&&(a=this.magnitudeLength(new Point(-a.x,
a.y)),this._animate.clear().now({x:a.x,y:a.y},c,animate.linear))}));this.on("bullet:touchRightWall",bind(this,function(){a.x>b&&(a=this.magnitudeLength(new Point(2*b-a.x,a.y)),this._animate.clear().now({x:a.x,y:a.y},c,animate.linear))}))};this.updateAsFlyingBullet=function(){0<this.style.y?(this.style.x<=r&&this.emit("bullet:touchLeftWall"),this.style.x+r>=this._deviceWidth&&this.emit("bullet:touchRightWall")):(this._animate.clear(),this.removeFromSuperview())};this.updateAsNormalBubble=function(a){var a=
a._bullet,b=new Point(a.style.x,a.style.y),c=new Point(this.style.x,this.style.y);b.subtract(c).getMagnitude()<=2*r&&(a._animate.clear(),this.deployBulletAfterHit(b.getAngle(),a),this._sound.play("attack"),a._hit=!0,this.searchOverlapBubble(a))};this.searchOverlapBubble=function(a){var b=this.getSuperview()._bubbles,c=!1,d;for(d in b){var f=new Point(a.style.x,a.style.y),e=new Point(b[d].style.x,b[d].style.y);f.subtract(e).getMagnitude()<=2*r+config.bias&&(b[d]._type==config.keyType&&(c=!0),a._edges[d]=
b[d],b[d]._edges[a.uid]=a)}b[a.uid]=a;if(c)setTimeout(bind(this,function(){this.getSuperview().emit("app:end",!0)}),300);else{var g=this.checkRemoveBFS(a);3<=g.length&&setTimeout(bind(this,function(){this.removeBubbles(g,b);setTimeout(bind(this,function(){this.removeSuspendBubble(b)}),400)}),400)}};this.checkRemoveBFS=function(a){var b=[],c=0,d=0,f=[],e=[];for(b.push(a);c<=d;){a=b[c];f[a.uid]=!0;c+=1;e.push(a);for(var g in a._edges){var h=a._edges[g];h._type==a._type&&!f[h.uid]&&(d+=1,b.push(h))}}return e};
this.removeSuspendBubble=function(a){var b=[],c;for(c in a)this.canAccessCelling(a[c])||b.push(a[c]);0<b.length&&this.removeBubbles(b,a,!0)};this.removeBubbles=function(a,b,c){for(var d=a[0].getSuperview(),f=0;f<a.length;f++){var e=a[f],g;for(g in e._edges)delete e._edges[g]._edges[e.uid];delete b[e.uid];e.removeFromSuperview()}this._sound.play("bubble_xiaochu");c||setTimeout(bind(this,function(){var a=admire[Math.floor(3*Math.random())];this._sound.play(a);"perfect"==a?a=d._perfect:"great"==a?a=
d._great:"nice"==a&&(a=d._nice);a.show();setTimeout(function(){a.hide()},500)}),600)};this.canAccessCelling=function(a){var b=[],c=0,d=0,f=[],e=[];b.push(a);if(a.style.y<=r)return!0;for(;c<=d;){a=b[c];f[a.uid]=!0;c+=1;e.push(a);for(var g in a._edges){var h=a._edges[g];if(h.style.y<=r)return!0;f[h.uid]||(d+=1,b.push(h))}}return!1};this.deployBulletAfterHit=function(a,b){for(var c=this.style,d=0;d<Edge.length;d++)if(Hexagon[d].s<a&&a<Hexagon[d].t){b.style.x=c.x+Edge[d].dx;b.style.y=c.y+Edge[d].dy;break}};
this.magnitudeLength=function(a){var b=this._origin,a=(new Point(a.x,a.y)).subtract(b);a.setMagnitude(this._magnLength);a.x+=b.x;a.y+=b.y;return a}});var r=GLOBAL.BUBBLE_RADIUS,r2=GLOBAL.BUBBLE_RADIUS2,types=GLOBAL.TYPES,Hexagon=config.Hexagon,Edge=config.Edge,admire=["perfect","nice","great"];
