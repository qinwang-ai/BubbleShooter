04e8decd41d7df4145b2368f23b2c0c5
jsio("import cache.LRUCache as LRUCache");jsio("import lib.PubSub as PubSub");
var WebGLTextureManager=__class__,WebGLTextureManager=WebGLTextureManager(function(){return this.init&&this.init.apply(this,arguments)},PubSub,function(){var i=1,j=Math.pow,k=Math.ceil,h=Math.log,l=h(2);this.init=function(){this.textureDataCache=new LRUCache(65535);this.textureByteCount=0;this.memoryLimit=268435456};this.initGL=function(a){this.gl=a;this.reloadTextures()};this.getTexture=function(a){return(a=this.textureDataCache.get(a))?a.texture:null};this.getTextureData=function(a){return this.textureDataCache.get(a)||
null};this.deleteTextureForImage=function(a){void 0!==a.__GL_ID&&this.deleteTexture(a.__GL_ID)};this.deleteTexture=function(a){this.emit(WebGLTextureManager.TEXTURE_REMOVED);if(a=this.textureDataCache.remove(a))this.gl.deleteTexture(a.texture),this.removeFromByteCount(a.width,a.height),a.image.__GL_ID=void 0};this.createOrUpdateTexture=function(a,c){var b=this.gl;if(!b)return-1;var e=a.width,f=a.height;a.dispose||(a.dispose=bind(this,function(){this.deleteTextureForImage(a)}));if(0===e||0===f)throw Error("Image cannot have a width or height of 0.");
void 0===c&&(c=void 0!==a.__GL_ID?a.__GL_ID:i++);a.__GL_ID=c;var d=this.textureDataCache.find(c),d=d?d.value:null,g=!1;d?b.bindTexture(b.TEXTURE_2D,d.texture):(d={image:a,isImg:a instanceof Image,isCanvas:a instanceof HTMLCanvasElement,width:e,height:f,texture:b.createTexture()},b.bindTexture(b.TEXTURE_2D,d.texture),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),
this.textureDataCache.put(c,d),g=!0);if(d.width!==e||d.height!==f)this.removeFromByteCount(d.width,d.height),d.width=e,d.height=f,g=!0;d.image!==a&&(d.image.__GL_ID=void 0,d.image=a,d.isImg=a instanceof Image,d.isCanvas=a instanceof HTMLCanvasElement);d.isImg||d.isCanvas?b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a):b.texImage2D(b.TEXTURE_2D,0,b.RGBA,e,f,0,b.RGBA,b.UNSIGNED_BYTE,null);g&&this.addToByteCount(e,f);return c};this.reloadTextures=function(){var a=[];this.textureDataCache.forEach(function(b,
c){(c.isImg||c.isCanvas)&&a.push(c.image)},this);this.textureDataCache.removeAll();for(var c=this.textureByteCount=0,b=a.length;c<b;c++)this.createOrUpdateTexture(a[c])};this.addToByteCount=function(a,c){a=this.nextPowerOfTwo(a);c=this.nextPowerOfTwo(c);this.textureByteCount+=4*a*c;for(var b=0;268435456<this.textureByteCount&&5>b++;){var e=this.textureDataCache.head;e&&(e.value.isImg?this.deleteTexture(e.key):this.textureDataCache.get(e.key))}};this.removeFromByteCount=function(a,c){a=this.nextPowerOfTwo(a);
c=this.nextPowerOfTwo(c);this.textureByteCount-=4*a*c};this.nextPowerOfTwo=function(a){return j(2,k(h(a)/l))}});WebGLTextureManager.TEXTURE_REMOVED="TextureRemoved";exports=WebGLTextureManager;
