664d6f0e100a429d40b9c938f571d21e
jsio("import lib.Callback");jsio("import .BasicDataSource as BasicDataSource");
var Users_tsunami_projects_devkitPoj_BubbleShooter_modules_devkit_core_modules_squill_models_DataSource=__class__,DataSource=exports=Users_tsunami_projects_devkitPoj_BubbleShooter_modules_devkit_core_modules_squill_models_DataSource(function(){return this.init&&this.init.apply(this,arguments)},BasicDataSource,function(j){var k={key:"id"};this.init=function(a){this._opts=a=merge(a,k);j(this,"init",[a]);this._byIndex=[];this._byID={};this._ctor=a.ctor;this._reverse=a.reverse;this.length=0;this.onLoad=
new lib.Callback;this.setSorter(a.sorter);this.setPersistence(a.persistence);this._changeDataSave=!1;this._changeData={updated:[],updatedHash:{},removed:[],removedHash:{}}};this.setPersistence=function(a){if(this._persistence=a)this.onLoad.clear(),a.load(this,this.onLoad.chain())};this._saveChanges=function(a,b){this._changeDataSave&&!this._changeData[a+"Hash"][b]&&(this._changeData[a+"Hash"][b]=!0,this._changeData[a].push(b))};this.getFilteredDataSource=function(a){var b=new DataSource(this._opts);
this.forEach(function(c){a(c)&&b.add(c)});this.subscribe("Update",function(c,d){a(d)?b.add(d):b.remove(d)});this.subscribe("Remove",function(a,d){b.remove(d)});return b};this.signalUpdate=function(a,b,c){if(void 0!==b[this.key])switch(a){case "UPDATE":this._saveChanges("updated",b[this.key]);this.publish("Update",b[this.key],b);break;case "REMOVE":this._saveChanges("removed",b[this.key]),this.publish("Remove",c,b)}};var i=function(){return this._sortKey};this.updated=this.add=function(a){if(isArray(a)){for(var b=
[],c=0,d=a.length;c<d;++c)if(a[c]){var e=this.add(a[c]);e&&b.push(e)}return b}b=a[this.key];if(null!=b){d=null;if(this._byID[b])for(c=0;e=this._byIndex[c];++c){if(e[this.key]==b){"function"==typeof e.update?(e.update(a),a=e):d=c;break}}else d=this.length++;null!==d&&(this._ctor&&!(a instanceof this._ctor)&&(a=new this._ctor(a)),this._byIndex[d]=a);this._byID[b]=a;this.signalUpdate("UPDATE",a);this._sorter&&(a._sortKey=this._sorter(a),a.toString=i);return a}};this.remove=function(a){"object"==typeof a&&
(a=a[this.key]);if(null!=a&&this._byID[a]){this.signalUpdate("REMOVE",this._byID[a],a);delete this._byID[a];for(var b=0,c;c=this._byIndex[b];++b)if(c[this.key]==a)return--this.length,this._byIndex.splice(b,1)[0]}};this.keepOnly=function(a){this.compare(a,function(a,c,d){d||a.remove(c)})};this.clear=function(){var a=this._byIndex;this._byIndex=[];this._byID={};for(var b=this.length=0,c;c=a[b];++b)this.signalUpdate("REMOVE",c,c[this.key])};this.getCount=function(){return this.length};this.setSorter=
function(a){if(this._sorter=a)for(var b=0,c;c=this._byIndex[b];++b)c._sortKey=a(c),c.toString=i;this.sort();return this};this.getIDs=function(){return this._byIndex.map(function(a){return a[this.key]},this)};this.contains=function(a){return!!this._byID[a]};this.getKey=function(){return this.key};this.get=this.getItemForID=function(a){return this._byID[a]||null};this.indexOf=function(a){return this._byIndex.indexOf(a)};this.getItemForIndex=function(a){return this._byIndex[a]};this.sort=function(){this._byIndex.sort();
this._reverse&&this._byIndex.reverse()};this.forEach=this.each=function(a,b){for(var c=0;c<this.length&&!a.call(b,this._byIndex[c],c);++c);};this.toJSON=function(){return{key:this.key,items:this._byIndex}};this.fromJSON=function(a){this.clear();this.key=a.key;this.add(a.items)};this.toArray=function(){return this._byIndex.slice(0)};this.beginChanges=function(){this._changeDataSave=!0;this._changeData={updated:[],updatedHash:{},removed:[],removedHash:{}}};this.saveChanges=function(){this._changeDataSave=
!1;if(this._persistence){var a=this._changeData,b,c;this._persistence.remove(a.removed);if(a.updated.length){var d=[];b=0;for(c=a.updated.length;b<c;b++)d.push(this._byID[a.updated[b]]);this._persistence.update(d)}this._persistence.commit()}};this.load=function(a){this._persistence&&this._persistence.load(this,function(b){b&&logger.LOG&&console.log("LOG",".models.DataSource","error loading",JSON.stringify(b));a&&a(b)})};this.save=function(){this._persistence&&this._persistence.save(this)};this.compare=
function(a,b){var c=this.key,d={};if(isArray(a))for(var e=0,g=a.length;e<g;++e)d[a[e][c]]=a[e];else for(var f in a)d[f]=a[f];for(var g=this._byIndex.slice(0),e=0,h;h=g[e];++e)f=h[c],b.call(this,this,h,d[f]),delete d[f];for(f in d)b.call(this,this,null,d[f])};this.filter=function(a){var b=new DataSource({key:this.key}),c,d,e,g,f=this.length;b.key=this.key;for(g=0;g<f;++g){d=this._byIndex[g];e=!0;for(c in a)"string"==typeof d[c]&&-1==d[c].toLowerCase().indexOf(a[c])&&(e=!1);e&&b.add(d)}return b}});
