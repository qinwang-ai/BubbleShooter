0944f3a1b88514ec3c2ac6df60e5fd8a
/*

 This file is part of the Game Closure SDK.

 The Game Closure SDK is free software: you can redistribute it and/or modify
 it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.

 The Game Closure SDK is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 Mozilla Public License v. 2.0 for more details.

 You should have received a copy of the Mozilla Public License v. 2.0
 along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.
*/
jsio("import device");jsio("import event.Callback as Callback");jsio("import animate");jsio("import event.input.InputEvent as InputEvent");jsio("import math.geom.Point as Point");jsio("from util.browser import $");jsio("import ..BaseBacking");var Canvas=device.get("Canvas"),AVOID_CSS_ANIM=device.isAndroid,TRANSFORM_PREFIX="transform";
function CHECK_TRANSLATE3D(){var l=document.createElement("p"),m,a={webkitTransform:"-webkit-transform",OTransform:"-o-transform",msTransform:"-ms-transform",MozTransform:"-moz-transform",transform:"transform"};document.body.insertBefore(l,null);for(var b in a)void 0!==l.style[b]&&(l.style[b]="translate3d(1px,1px,1px)",m=window.getComputedStyle(l).getPropertyValue(a[b]),TRANSFORM_PREFIX=b);document.body.removeChild(l);return void 0!==m&&0<m.length&&"none"!==m}
var SUPPORTS_TRANSLATE3D=!1,Users_tsunami_projects_devkitPoj_BubbleShooter_modules_devkit_core_modules_timestep_src_ui_backend_dom_ViewBacking=__class__,ViewBacking=exports=Users_tsunami_projects_devkitPoj_BubbleShooter_modules_devkit_core_modules_timestep_src_ui_backend_dom_ViewBacking(function(){return this.init&&this.init.apply(this,arguments)},BaseBacking,function(){var l={};"x y r width height visible anchorX anchorY offsetX offsetY opacity scale zIndex scrollLeft scrollTop flipX flipY".split(" ").forEach(function(a){l[a]=
!0;this.__defineGetter__(a,function(){return a in this._computed?this._computed[a]:parseInt(this._node.style[a])});this.__defineSetter__(a,function(b){var c={};c[a]=b;this._setProps(c);return b})},this);this.init=function(a,b){this._view=a;this._subviews=[];this._noCanvas=b["dom:noCanvas"];var c=this._node=document.createElement(b["dom:elementType"]||"div");c._view=a;c.addEventListener("webkitTransitionEnd",bind(this,"_transitionEnd"),!1);c.className="view";b["dom:className"]&&(c.className+=" "+b["dom:className"]);
var d="fontSize:1px;position:absolute;top:0px;left:0px;-webkit-transform-origin:0px 0px;";device.isAndroid||(d+="-webkit-backface-visibility:hidden;");var i=c.style;i.cssText=d;this.position(0,0);var d=b["dom:styles"],k;for(k in d)i[k]=d[k];this._computed={x:0,y:0,r:0,width:void 0,height:void 0,anchorX:0,anchorY:0,offsetX:0,offsetY:0,opacity:1,visible:!0,zIndex:0,scale:1};this._view.getAnimation=function(){return this.__view};this._animating=!1;this._animationQueue=[];this._animationCallback=null;
DEBUG&&c.setAttribute("TAG:",a.getTag())};this.getElement=function(){return this._node};var m=9E5;this.addSubview=function(a){var b=a.__view,c=b._node,d=c.parentNode&&c.parentNode._view;if(d==this._view)return!1;d&&d.__view.removeSubview(a);a=this._subviews.length;this._subviews[a]=b;this._node.appendChild(c);b._setAddedAt(++m);a&&b.__sortKey<this._subviews[a-1].__sortKey&&(this._needsSort=!0);return!0};this.removeSubview=function(a){var b=this._subviews.indexOf(a.__view);return-1!=b?(this._subviews.splice(b,
1),this._node.removeChild(a.__view._node),!0):!1};this.getSuperview=function(){var a=this._node.parentNode;return a==document.body||!a?null:a._view};this.getSubviews=function(){this._needsSort&&(this._needsSort=!1,this._subviews.sort());for(var a=[],b=this._subviews.length,c=0;c<b;++c)a[c]=this._subviews[c]._view;return a};this.wrapTick=function(a,b){this._view.tick&&this._view.tick(a,b);for(var c=0,d;d=this._subviews[c];++c)d.wrapTick(a,b)};this.wrapRender=function(a,b){if(this.visible){this._needsSort&&
(this._needsSort=!1,this._subviews.sort());var c=this._computed.width,d=this._computed.height;if(!(0>c||0>d))try{var i=this._view.render;i&&!i.isFake&&this._render(i,c,d,b);this._renderSubviews(a,b)}catch(k){logger.ERROR&&console.error("ERROR",".backend.dom.ViewBacking",this,k.message,k.stack)}}};this._render=function(a,b,c,d){if(this._noCanvas)a.call(this._view,null,d);else{this._canvas||(this._canvas=new Canvas,this._node.insertBefore(this._canvas,this._node.firstChild),this.ctx=this._canvas.getContext("2d"));
var i=this._view._needsRepaint;if((b|0)!=this._canvas.width||(c|0)!=this._canvas.height)i=!0,this._canvas.width=b,this._canvas.height=c;i&&(this._view._needsRepaint=!1,this._canvas.style.display="none",this.ctx.clear(),this.ctx.save(),a.call(this._view,this.ctx,d),this.ctx.restore(),this._canvas.style.display="block")}};this._renderSubviews=function(a,b){for(var c=0,d,i=this._subviews;d=i[c++];)d.wrapRender(a,b)};this.localizePoint=function(a){var b=this._computed;a.x-=b.x+b.anchorX+b.offsetX;a.y-=
b.y+b.anchorY+b.offsetY;b.r&&a.rotate(-b.r);a.scale(1/b.scale);a.x+=b.anchorX;a.y+=b.anchorY;return a};this.copy=function(){return merge({},this._computed)};this.update=function(a){this._setProps(a)};this.position=function(a,b){var c=this._node.style;if(SUPPORTS_TRANSLATE3D){var d="translate3d("+a+"px,"+b+"px,0)";c[TRANSFORM_PREFIX]=""!=c[TRANSFORM_PREFIX]&&c[TRANSFORM_PREFIX]!=d?c[TRANSFORM_PREFIX]+d:d}else c.left=a+"px",c.top=b+"px"};this._updateOrigin=function(){this._node.style.webkitTransformOrigin=
(this._computed.anchorX||0)+"px "+(this._computed.anchorY||0)+"px"};this._setProps=function(a,b){var c=!1,d=this._node.style,i=0,k=!1,g={},f;for(f in a){var h=a[f];if("dx"==f||"dy"==f)f=f.substr(1),h=this._computed[f]+h;switch(f){case "anchorX":case "anchorY":this._computed[f]=h;this._updateOrigin();break;case "clip":this._computed.clip=h;d.overflow=h?"hidden":"visible";break;case "zIndex":this._computed.zIndex!=h&&(this._computed.zIndex=h,d.zIndex=h,this._onZIndex(h));break;case "offsetX":case "offsetY":case "x":case "y":case "r":case "scale":this._computed[f]!=
h&&(g[f]=this._computed[f],this._computed[f]=h,c=!0);break;default:this._computed[f]!=h&&(++i,this._computed[f]=h,"width"==f||"height"==f?(d[f]=h+"px",k=!0):"visible"==f?d.display=h?this._displayStyle||"block":"none":"opacity"==f?d[f]=h:(d[f]=h,l[f]||(this[f]=h)))}}if(c){++i;var e=this._computed,c=(this._center?-e.width/2|0:0)+e.x+e.offsetX;f=(this._center?-e.height/2|0:0)+e.y+e.offsetY;if(AVOID_CSS_ANIM){var j={scale:g.scale||e.scale,r:g.r||e.r};if(b&&(j.scale!=e.scale||j.r!=e.r))animate(j).now({scale:e.scale,
r:e.r},b.duration,b.easing,bind(this,function(){d.WebkitTransform="scale("+(e.flipX?-1*j.scale:j.scale)+","+(e.flipY?-1*j.scale:j.scale)+") rotate("+j.r+"rad)"})).then(bind(this,function(){d.WebkitTransform="scale("+(e.flipX?-1*j.scale:j.scale)+","+(e.flipY?-1*j.scale:j.scale)+") rotate("+e.r+"rad)"}));else if(j.scale!=e.scale||j.r!=e.r)d.WebkitTransform="scale("+(e.flipX?-1*e.scale:e.scale)+","+(e.flipY?-1*e.scale:e.scale)+") rotate("+e.r+"rad)";this.position(c,f)}else{g=new WebKitCSSMatrix;g=g.translate(c,
f);g=g.rotate(180*e.r/3.14159);g=g.scale(e.scale);if(e.flipX||e.flipY)g=g.translate(e.flipX?-e.width:0,e.flipY?e.height/2:0),g=g.scale(e.flipX?-1:1,e.flipY?-1:1),g=g.translate(e.flipX?e.width:0,e.flipY?-e.height/2:0);g=g.rotate(0,360,0);d.WebkitTransform=g}}k&&this._view.needsReflow();return i};this._sortIndex="00000000";this._onZIndex=function(a){a=~~a;-99999999>a&&(a=this._zIndex=-99999999);99999999<a&&(a=this._zIndex=99999999);0>a?(a*=-1,this._sortIndex="-"+"00000000".substring(0,8-(""+a).length)+
a):this._sortIndex="00000000".substring(0,8-(""+a).length)+a;this._setSortKey()};this._setAddedAt=function(a){this._addedAt=a;this._setSortKey()};this._setSortKey=function(){this.__sortKey=this._sortIndex+this._addedAt};this.toString=function(){return this.__sortKey};this._transitionEnd=function(a){$.stopEvent(a);this.transitionCallback.fired()||(this.transitionCallback.fire(),this.transitionCallback.reset(),a?a.cancelBubble=!0:this._transitionEndTimeout&&(this._transitionEndTimeout=null),this._node.style.webkitTransition=
"none",this._animating=!1,this._animationCallback&&(a=this._animationCallback,this._animationCallback=null,a()),this._processAnimation())};this._processAnimation=function(a){if(!(0==this._animationQueue.length||this._isPaused))if(a&&(clearTimeout(this._queuedTimeout),this._queuedTimeout=null),!this._queuedTimeout)if(a)switch(a=this._animationQueue.shift(),a.type){case "animate":var b=this._node.style;b.webkitTransitionProperty=AVOID_CSS_ANIM?"left, top, opacity, width, height":"-webkit-transform, opacity, width, height";
b.webkitTransitionDuration=(a.duration|0)+"ms";b.webkitTransitionTimingFunction="string"==typeof a.easing?a.easing:a.easing==animate.easeIn?"ease-in":a.easing==animate.easeOut?"ease-out":a.easing==animate.easeInOut?"ease-in-out":a.easing==animate.linear?"linear":"ease";this._setProps(a.props,a);case "wait":this._animating=!0;this._animationCallback=a.callback||null;this.transitionCallback=new Callback;this.transitionCallback.runOrTimeout(function(){},bind(this,function(a){this._transitionEnd(a)}),
a.duration);break;case "callback":a.callback(),this._animating||this._processAnimation()}else this._queuedTimeout||(this._queuedTimeout=setTimeout(bind(this,function(){this._queuedTimeout=false;this._processAnimation(true)}),0))};this.getQueue=function(){return[]};this.getAnimation=function(){return this};this.animate=function(){return!arguments[0]?this:this.next.apply(this,arguments)};this.clear=function(){this.transitionCallback&&this.transitionCallback.fire();this._transitionEndTimeout&&clearTimeout(this._transitionEndTimeout);
this._animationQueue=[];this._animationCallback=null;this._animating=!1;return this};this.commit=function(){this._node.style.webkitTransition="none";var a=this._animationQueue;this._animationQueue=[];for(var b=a.length,c=0;c<b;++c){var d=a[c];switch(d.type){case "animate":this._setProps(d.props);break;case "callback":d.callback()}}return this};this.pause=function(){this._isPaused=!0};this.resume=function(){this._isPaused=!1;this._processAnimation()};this.animate=function(a,b,c,d){return this.then(a,
b,c,d)};this.now=function(a,b,c,d){this.clear();return this.then(a,b,c,d)};this.then=function(a,b,c,d){if(1==arguments.length&&"function"===typeof a)return this.callback(a);this._animationQueue.push({type:"animate",props:a,duration:b||600,callback:d&&bind(this,d),easing:c});1==this._animationQueue.length&&!this._animating&&this._processAnimation();return this};this.callback=function(a){this._animationQueue.push({type:"callback",duration:0,callback:a&&bind(this,a)});1==this._animationQueue.length&&
!this._animating&&this._processAnimation();return this};this.wait=function(a,b){this._animationQueue.push({type:"wait",duration:a,callback:b});1==this._animationQueue.length&&!this._animating&&this._processAnimation();return this};this.fadeIn=function(a,b){this.show();if(1==this._node.style.opacity)b&&b();else return this.then({opacity:1},a,null,b),this};this.fadeOut=function(a,b){if(0==this._node.style.opacity)this.hide(),b&&b();else return this.then({opacity:0},a,null,bind(this,function(){this.hide();
b&&b()})),this}});
