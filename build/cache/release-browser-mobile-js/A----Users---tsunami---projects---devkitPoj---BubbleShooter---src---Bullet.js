54a5e6fa3c49fa9f4679328642e10750
jsio("import ui.ImageView");jsio("import math.geom.Point as Point");jsio("import animate");jsio("import src.Config as config");jsio("import src.SoundController as Sound");jsio("import ui.ParticleEngine as ParticleEngine");var Users_tsunami_projects_devkitPoj_BubbleShooter_src_Bullet=__class__;
exports=Users_tsunami_projects_devkitPoj_BubbleShooter_src_Bullet(function(){return this.init&&this.init.apply(this,arguments)},ui.ImageView,function(i){this.init=function(a){a=merge(a,{x:165,y:450,width:2*r,height:2*r,offsetX:-r,offsetY:-r,image:types[0],type:0});i(this,"init",[a]);this._deviceWidth=GLOBAL.SCREEN_SIZE.width;this._magnLength=config.bulletMagnLength;this._delay=config.bulletSpeedDelay;this._sound=Sound.getSound();this._origin=new Point(this.style.x,this.style.y);this._type=a.type;
this._spark=this._shock=this._hit=!1;this._edges=[];this._pEngine=new ParticleEngine({superview:this});this.build()};this.build=function(){var a,b=this._deviceWidth,c=this._delay;this._animate=animate(this);this.on("bullet:launch",bind(this,function(b){this._isLoaded?(a=this.magnitudeLength(b),this._sound.play("lightning"),this._animate.now({x:a.x,y:a.y},c,animate.linear),this._isLoaded=!1):console.error("Bullet.build : bullet not loaded")}));this.on("bullet:touchLeftWall",bind(this,function(){0>
a.x&&(a=this.magnitudeLength(new Point(-a.x,a.y)),this._animate.clear().now({x:a.x,y:a.y},c,animate.linear))}));this.on("bullet:touchRightWall",bind(this,function(){a.x>b&&(a=this.magnitudeLength(new Point(2*b-a.x,a.y)),this._animate.clear().now({x:a.x,y:a.y},c,animate.linear))}))};this.updateParticle=function(){this._shock&&this.bulletParticle();this._spark&&this.bulletSpark();this._pEngine.runTick(500)};this.bulletParticle=function(){for(var a=this._pEngine.obtainParticleArray(10),b=0;10>b;b++){var c=
a[b];c.dx=10*Math.random();c.width=33;c.height=33;this._animate.hasFrames()?(c.dy=10*Math.random(),c.image=GLOBAL.BULLET_PARTICLE[this._type]):(c.dy=10*-Math.random(),c.image=GLOBAL.TYPES[this._type])}this._pEngine.emitParticles(a)};this.bulletSpark=function(){for(var a=this._pEngine.obtainParticleArray(5),b=0;5>b;b++){var c=a[b];c.dx=40*Math.random()-20;c.dy=40*Math.random()-20;c.width=40;c.height=40;c.image="resources/images/bomb.png"}this._pEngine.emitParticles(a)};this.updateAsFlyingBullet=function(){0<
this.style.y?(this.style.x<=r&&this.emit("bullet:touchLeftWall"),this.style.x+r>=this._deviceWidth&&this.emit("bullet:touchRightWall")):(this._animate.clear(),this.removeFromSuperview())};this.updateAsNormalBubble=function(a){var a=a._bullet,b=new Point(a.style.x,a.style.y),c=new Point(this.style.x,this.style.y);b.subtract(c).getMagnitude()<=2*r&&(a._animate.clear(),this.deployBulletAfterHit(b.getAngle(),a),this._sound.play("attack"),a._hit=!0,this.searchOverlapBubble(a))};this.shock=function(){var a=
this;a._shock=!0;setTimeout(function(){a._shock=!1},200)};this.spark=function(){var a=this;a._spark=!0;this._sound.play("bubble_xiaochu");setTimeout(function(){a._spark=!1},200)};this.searchOverlapBubble=function(a){var b=this.getSuperview()._bubbles,c=!1,d;for(d in b){var e=new Point(a.style.x,a.style.y),f=new Point(b[d].style.x,b[d].style.y);if(e.subtract(f).getMagnitude()<=2*r+config.bias){if(b[d]._type==config.keyType){c=!0;break}a._edges[d]=b[d];b[d]._edges[a.uid]=a;b[d].shock()}}b[a.uid]=a;
if(c)setTimeout(bind(this,function(){this.getSuperview().emit("app:end",!0)}),300);else{var g=this.checkRemoveBFS(a);3<=g.length&&setTimeout(bind(this,function(){this.removeBubbles(g,b);setTimeout(bind(this,function(){this.removeSuspendBubble(b)}),400)}),400)}};this.checkRemoveBFS=function(a){var b=[],c=0,d=0,e=[],f=[];for(b.push(a);c<=d;){a=b[c];e[a.uid]=!0;c+=1;f.push(a);for(var g in a._edges){var h=a._edges[g];h._type==a._type&&!e[h.uid]&&(d+=1,b.push(h))}}return f};this.removeSuspendBubble=function(a){var b=
[],c;for(c in a)this.canAccessCelling(a[c])||b.push(a[c]);0<b.length&&this.removeBubbles(b,a,!0)};this.removeBubbles=function(a,b,c){var d=a[0].getSuperview();d._isRemoving=!0;for(var e=0;e<a.length;e++){var f=a[e],g;for(g in f._edges)delete f._edges[g]._edges[f.uid];f.spark()}setTimeout(function(){for(var c=0;c<a.length;c++){var e=a[c];e.removeFromSuperview();delete b[e.uid]}setTimeout(function(){d._isRemoving=!1},200)},300);c||setTimeout(bind(this,function(){var a=admire[Math.floor(3*Math.random())];
this._sound.play(a);"perfect"==a?a=d._perfect:"great"==a?a=d._great:"nice"==a&&(a=d._nice);a.show();setTimeout(function(){a.hide()},500)}),600)};this.canAccessCelling=function(a){var b=[],c=0,d=0,e=[],f=[];b.push(a);if(a.style.y<=r)return!0;for(;c<=d;){a=b[c];e[a.uid]=!0;c+=1;f.push(a);for(var g in a._edges){var h=a._edges[g];if(h.style.y<=r)return!0;e[h.uid]||(d+=1,b.push(h))}}return!1};this.deployBulletAfterHit=function(a,b){for(var c=this.style,d=0;d<Edge.length;d++)if(Hexagon[d].s<a&&a<Hexagon[d].t){b.style.x=
c.x+Edge[d].dx;b.style.y=c.y+Edge[d].dy;break}};this.magnitudeLength=function(a){var b=this._origin,a=(new Point(a.x,a.y)).subtract(b);a.setMagnitude(this._magnLength);a.x+=b.x;a.y+=b.y;return a}});var r=GLOBAL.BUBBLE_RADIUS,r2=GLOBAL.BUBBLE_RADIUS2,types=GLOBAL.TYPES,Hexagon=config.Hexagon,Edge=config.Edge,admire=["perfect","nice","great"];
