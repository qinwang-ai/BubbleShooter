d7f985108c4b82554cf01a49622311e0
jsio("import ui.ImageView");jsio("import math.geom.Point as Point");jsio("import animate");jsio("import src.Config as config");jsio("import src.SoundController as Sound");jsio("import ui.ParticleEngine as ParticleEngine");var Users_tsunami_projects_devkitPoj_BubbleShooter_src_Bullet=__class__;
exports=Users_tsunami_projects_devkitPoj_BubbleShooter_src_Bullet(function(){return this.init&&this.init.apply(this,arguments)},ui.ImageView,function(i){this.init=function(a){a=merge(a,{x:165,y:450,width:2*r,height:2*r,offsetX:-r,offsetY:-r,image:types[0],type:0});i(this,"init",[a]);this._deviceWidth=GLOBAL.SCREEN_SIZE.width;this._magnLength=config.bulletMagnLength;this._delay=config.bulletSpeedDelay;this._sound=Sound.getSound();this._origin=new Point(this.style.x,this.style.y);this._type=a.type;
this._spark=this._shock=this._hit=!1;this._edges=[];this._pEngine=new ParticleEngine({superview:this});this.build()};this.build=function(){var a,c=this._deviceWidth,b=this._delay;this._animate=animate(this);this.on("bullet:launch",bind(this,function(c){this._isLoaded?(a=this.magnitudeLength(c),this._sound.play("lightning"),this._animate.now({x:a.x,y:a.y},b,animate.linear),this._isLoaded=!1):console.error("Bullet.build : bullet not loaded")}));this.on("bullet:touchLeftWall",bind(this,function(){0>
a.x&&(a=this.magnitudeLength(new Point(-a.x,a.y)),this._animate.clear().now({x:a.x,y:a.y},b,animate.linear))}));this.on("bullet:touchRightWall",bind(this,function(){a.x>c&&(a=this.magnitudeLength(new Point(2*c-a.x,a.y)),this._animate.clear().now({x:a.x,y:a.y},b,animate.linear))}))};this.updateParticle=function(){this._shock&&this.bulletParticle();this._spark&&this.bulletSpark();this._pEngine.runTick(500)};this.bulletParticle=function(){for(var a=this._pEngine.obtainParticleArray(10),c=0;10>c;c++){var b=
a[c];b.dx=10*Math.random();b.width=33;b.height=33;this._animate.hasFrames()?(b.dy=10*Math.random(),b.image=GLOBAL.BULLET_PARTICLE[this._type]):(b.dy=10*-Math.random(),b.image=GLOBAL.TYPES[this._type])}this._pEngine.emitParticles(a)};this.bulletSpark=function(){for(var a=this._pEngine.obtainParticleArray(5),c=0;5>c;c++){var b=a[c];b.dx=40*Math.random()-20;b.dy=40*Math.random()-20;b.width=40;b.height=40;b.image="resources/images/bomb.png"}this._pEngine.emitParticles(a)};this.updateAsFlyingBullet=function(){0<
this.style.y?(this.style.x<=r&&this.emit("bullet:touchLeftWall"),this.style.x+r>=this._deviceWidth&&this.emit("bullet:touchRightWall")):this._animate.clear()};this.updateAsNormalBubble=function(a){var a=a._bullet,c=new Point(a.style.x,a.style.y),b=new Point(this.style.x,this.style.y);c.subtract(b).getMagnitude()<=2*r&&(a._animate.clear(),this.deployBulletAfterHit(c.getAngle(),a),this._sound.play("attack"),a._hit=!0,this.searchOverlapBubble(a))};this.shock=function(){var a=this;a._shock=!0;setTimeout(function(){a._shock=
!1},200)};this.spark=function(){var a=this;a._spark=!0;this._sound.play("bubble_xiaochu");setTimeout(function(){a._spark=!1},200)};this.searchOverlapBubble=function(a){var c=this.getSuperview(),b=c._bubbles,d=!1,e;for(e in b){var f=new Point(a.style.x,a.style.y),h=new Point(b[e].style.x,b[e].style.y);if(f.subtract(h).getMagnitude()<=2*r+config.bias){if(b[e]._type==config.keyType){d=!0;break}a._edges[e]=b[e];b[e]._edges[a.uid]=a;b[e].shock()}}b[a.uid]=a;if(d)setTimeout(bind(this,function(){c.emit("app:end",
!0)}),300);else{var g=this.checkRemoveBFS(a);3<=g.length&&(c._isRemoving=!0,setTimeout(bind(this,function(){this.removeBubbles(g,b);setTimeout(bind(this,function(){this.removeSuspendBubble(b)}),400)}),400))}};this.checkRemoveBFS=function(a){var c=[],b=0,d=0,e=[],f=[];for(c.push(a);b<=d;){a=c[b];e[a.uid]=!0;b+=1;f.push(a);for(var h in a._edges){var g=a._edges[h];g._type==a._type&&!e[g.uid]&&(d+=1,c.push(g))}}return f};this.removeSuspendBubble=function(a){var c=[],b;for(b in a)this.canAccessCelling(a[b])||
c.push(a[b]);0<c.length&&this.removeBubbles(c,a,!0)};this.removeBubbles=function(a,c,b){for(var d=a[0].getSuperview(),e=0;e<a.length;e++){var f=a[e],h;for(h in f._edges)delete f._edges[h]._edges[f.uid];f.spark()}setTimeout(function(){for(var b=0;b<a.length;b++){var e=a[b];e.removeFromSuperview();delete c[e.uid]}d._isRemoving=!1},300);b||setTimeout(bind(this,function(){var a=admire[Math.floor(3*Math.random())];this._sound.play(a);"perfect"==a?a=d._perfect:"great"==a?a=d._great:"nice"==a&&(a=d._nice);
a.show();setTimeout(function(){a.hide()},500)}),600)};this.canAccessCelling=function(a){var c=[],b=0,d=0,e=[],f=[];c.push(a);if(a.style.y<=r)return!0;for(;b<=d;){a=c[b];e[a.uid]=!0;b+=1;f.push(a);for(var h in a._edges){var g=a._edges[h];if(g.style.y<=r)return!0;e[g.uid]||(d+=1,c.push(g))}}return!1};this.deployBulletAfterHit=function(a,c){for(var b=this.style,d=0;d<Edge.length;d++)if(Hexagon[d].s<a&&a<Hexagon[d].t){c.style.x=b.x+Edge[d].dx;c.style.y=b.y+Edge[d].dy;break}};this.magnitudeLength=function(a){var c=
this._origin,a=(new Point(a.x,a.y)).subtract(c);a.setMagnitude(this._magnLength);a.x+=c.x;a.y+=c.y;return a}});var r=GLOBAL.BUBBLE_RADIUS,r2=GLOBAL.BUBBLE_RADIUS2,types=GLOBAL.TYPES,Hexagon=config.Hexagon,Edge=config.Edge,admire=["perfect","nice","great"];
