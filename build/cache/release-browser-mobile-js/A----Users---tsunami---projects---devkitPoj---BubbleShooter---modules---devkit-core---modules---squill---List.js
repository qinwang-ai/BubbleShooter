f6f57be7215ae696ec9f803d97266ed9
jsio("import .Window");jsio("import .Widget");jsio("from util.browser import $");jsio("import .models.DataSource as DataSource");jsio("import .models.DataItem as DataItem");jsio("import .Selection");
var Users_tsunami_projects_devkitPoj_BubbleShooter_modules_devkit_core_modules_squill_List=__class__,List=module.exports=Users_tsunami_projects_devkitPoj_BubbleShooter_modules_devkit_core_modules_squill_List(function(){return this.init&&this.init.apply(this,arguments)},Widget,function(i){this._css="list";this.init=function(a){a=merge(a,{containSelf:!0,cellSpacing:0,isTiled:!1,preserveCells:!1,renderAll:!0,isFixedHeight:!0,absolutePosition:!0,filter:null});this.needsRender=delay(this.render);a.cellCtor&&
this.setCellCtor(a.cellCtor);a.dataSource&&this.setDataSource(a.dataSource);a.sorter&&this.setSorter(a.sorter);this._lastFilter=null;this._cellsByID={};this._removed={};this._containSelf=a.containSelf;this._containerTag=a.containerTag;this._applyNodeOrder=a.applyNodeOrder;this._renderOpts={cellSpacing:a.cellSpacing||0};this.setFilter(a.filter);this.updateFilter=delay(function(){this._lastFilter=null;this.needsRender()},100);i(this,"init",[a]);a.__result&&a.__result.addSubscription(this,"select");
Window.get().on("ViewportChange",bind(this,"needsRender"))};this.getContainer=function(){return this._container};this.getDataSource=function(){return this._dataSource};this.setModel=function(a,b){if(1==arguments.length)this.setDataSource(arguments[0]);else return i(this,"setModel",arguments)};this.setData=function(a){this._dataSource?this._dataSource.clear():this.setDataSource(new DataSource({sorter:this._sorter}));a&&this._dataSource.add(Array.isArray(a)?a.map(function(a,c){return new DataItem(c,
a)}):Object.keys(a).map(function(b){return new DataItem(b,a[b])}));this.needsRender()};this.setDataSource=function(a){this._dataSource!=a&&(this._dataSource&&(this._dataSource.unsubscribe("Update",this),this._dataSource.unsubscribe("Remove",this),this.clear()),this._dataSource=a,this._dataSource.subscribe("Update",this,"onUpdateItem"),this._dataSource.subscribe("Remove",this,"onRemoveItem"),this.needsRender())};this.onUpdateItem=function(a,b){var c=this._cellsByID[a];if(c){var d=c.getItem();b instanceof
DataItem?d!==b.data&&c.setItem(b.data,b):d!==b&&c.setItem(b)}this.updateFilter()};this.onRemoveItem=function(a){this._removed[a]=!0;this.updateFilter()};this.buildWidget=function(){this._container=$({parent:this._el,className:this._opts.containerClassName,tag:this._containerTag||"div"});this._containSelf&&!this._applyNodeOrder&&(this._container.style.position="relative");if(this._opts.selection||this._opts.selectable)this.setSelectable(this._opts.selection||this._opts.selectable);this.render()};this.setValue=
function(a){this.selection&&this.selection.select(a)};this.getValue=function(){if(this.selection)return this.selection.get()};this.setSelectable=function(a){this.selection=(new Selection({parent:this,type:a})).subscribe("Select",this,"_onSelected",!0).subscribe("Deselect",this,"_onSelected",!1);this.selection};this._onSelected=function(a,b,c){void 0!==this._cellsByID[c]&&(this._cellsByID[c].updateSelected(),a&&(b instanceof DataItem?this.emit("select",c,b.data):this.emit("select",c,b)))};this.setCellCtor=
function(a){a!=this._cellCtor&&(this._cellCtor=a,this.clear())};this.clear=function(){for(var a in this._cellsByID)this._cellsByID[a].remove();this._cellsByID={};this._cellDim=this._renderedDataSource=null};this.getCell=this.getCellById=function(a){return this._cellsByID[a]};this.setCell=this.setCellForId=function(a,b){this._cellsByID[a]=b};this.getCells=function(){return this._cellsByID};this.setSorter=function(a){a!=this._rawSorter&&(this._rawSorter=a,this._sorter=function(b){return a(b instanceof
DataItem?b.data:b)});this._renderedDataSource&&this._renderedDataSource.setSorter(a)};this.setFilter=function(a){a!=this._rawFilter&&(this._rawFilter=a,this._filter=function(b){return a(b instanceof DataItem?b.data:b)});this.needsRender()};this.setFixedHeight=function(a){this._opts.isFixedHeight=a};this._applyDataSource=function(){if(this._filter!=this._lastFilter)this._lastFilter=this._filter,this._renderedDataSource=this._dataSource.getFilteredDataSource(this._filter),this._lastSorter=this._sorter,
this._renderedDataSource.setSorter(this._sorter);else if(this._sorter!=this._lastSorter){if(!this._renderedDataSource||this._renderedDataSource==this._dataSource)return this._filter=function(){return!0},this._applyDataSource();this._lastSorter=this._sorter;this._renderedDataSource.setSorter(this._sorter)}this._renderedDataSource||(this._renderedDataSource=this._dataSource)};this.onShow=function(){i(this,"onShow",arguments);this.needsRender()};this.render=function(){this._dataSource&&(this._applyDataSource(),
this._renderedDataSource.sort(),this._opts.renderAll?this.renderAllDelayed():this._opts.isFixedHeight?this.renderFixedHeight():this.renderDynamicHeight(),this._removed={})};this.setCellDim=function(a){this._cellDim=a};this.getCellDim=function(){if(this._cellDim)return this._cellDim;if(this._opts.isFixedHeight){var a=this._renderedDataSource.getItemForIndex(0);if(!a)return!1;var b=a[this._renderedDataSource.getKey()],a=this._cellsByID[b]||(this._cellsByID[b]=this._createCell(a)),a=$.size(a.getElement());
if(0==a.width||0==a.height)return null;if(b=this._opts.cellSpacing)a.width+=b,a.height+=b;return this._cellDim=a}throw"unimplemented";};this._createCell=function(a){var b=this._dataSource.getKey(),c=new this._cellCtor({parent:this,controller:this,key:b,item:a});c.getElement().setAttribute("squill-data-id",a[b]);c.render();return c};this._nodeOrder=function(){var a=this._container,b=this._renderedDataSource,c=b.key,d,e,f,g;if(a.childNodes.length){d=document.createElement("div");a.insertBefore(d,a.childNodes[0]);
for(g=0;g<b.length;g++)e=b.getItemForIndex(g),e=this._cellsByID[e[c]],f=e.getElement(),e&&f.parentNode&&a.insertBefore(a.removeChild(f),d);a.removeChild(d)}};this.renderAllDelayed=function(){function a(){this._renderManyTimeout&&(clearTimeout(this._renderManyTimeout),this._renderManyTimeout=void 0);for(var d=0,e=+new Date;10>d++||50>+new Date-e;){var f;if(f=b.getItemForIndex(c)){var i=f[b.getKey()],j=this._cellsByID[i];j?j.render():j=this._cellsByID[i]=this._createCell(f);!this._applyNodeOrder&&this.positionCell(j,
c);++c;f=!0}else f=!1;if(!f){this._applyNodeOrder&&this._nodeOrder();return}}this._renderManyTimeout=setTimeout(bind(this,a),100)}var b=this._renderedDataSource;if(b&&this.updateRenderOpts()){var c=0,d=this._removed,e;for(e in d)if(!b.getItemForID(e)){var f=this._cellsByID[e];f&&(f.remove(),delete this._cellsByID[e])}a.call(this)}};this.setOffsetParent=function(a){this._opts.offsetParent=a};this.setTiled=function(a){this._isTiled=this._opts.isTiled=a};this.updateRenderOpts=function(){var a=this._renderOpts;
a.offsetTop=this._containSelf?0:this._container.offsetTop;a.offsetLeft=this._containSelf?0:this._container.offsetLeft;var b=this._offsetParent||this.getOffsetParent();a.top=(b.getAttribute("squill-scroller-top")||b.scrollTop)-a.offsetTop;a.height=b.offsetHeight;a.bottom=a.top+a.height;if(this._opts.isFixedHeight){var c=this.getCellDim();if(!c)return!1;a.cellWidth=c.width;a.cellHeight=c.height}c=a.numRows=this._renderedDataSource.length;this._opts.isFixedHeight&&(this._opts.isTiled?(a.maxWidth=b.offsetWidth-
a.offsetLeft,a.numPerRow=Math.max(1,a.maxWidth/a.cellWidth|0),a.numRows=Math.ceil(c/a.numPerRow),a.start=Math.max(0,(a.top/a.cellHeight|0)*a.numPerRow),a.end=Math.ceil(a.bottom/a.cellHeight)*a.numPerRow):(a.start=Math.max(0,a.top/a.cellHeight|0),a.end=a.bottom/a.cellHeight+1|0));this._applyNodeOrder||(this._container.style.height=this._opts.absolutePosition?a.numRows*a.cellHeight+"px":"auto");return!0};this.positionCell=function(a,b){if(this._opts.absolutePosition){var c=this._renderOpts,d=a.getElement(),
e,f;this._opts.isTiled?(e=b%c.numPerRow,f=b/c.numPerRow|0,d.style.left=e*c.cellWidth+c.offsetLeft+"px",d.style.top=f*c.cellHeight+c.offsetTop+"px"):d.style.top=(b*c.cellHeight||0)+c.offsetTop+"px"}};this.getOffsetParent=function(){return this._opts.offsetParent||(this._containSelf?this._container:this._container.offsetParent)||document.body};this.renderFixedHeight=function(){var a=this.getOffsetParent();if(a){a!=this._offsetParent&&(this._removeScrollEvt&&this._removeScrollEvt(),this._offsetParent=
a,this._removeScrollEvt=$.onEvent(a,"scroll",this,"needsRender"));var a=this._renderedDataSource,b=a.getKey(),c=a.length;if(!c||this.updateRenderOpts()){var d=this._cellsByID;this._cellsByID={};if(c)for(var c=this._renderOpts,e=c.start;e<c.end;++e){var f=a.getItemForIndex(e);if(!f)break;var g=f[b],h=d[g];h?(delete d[g],h.render()):h=this._createCell(f);this.positionCell(h,e);this._cellsByID[g]=h}if(this._opts.preserveCells)for(g in d)h=d[g],a.getItemForID(g)?this._cellsByID[g]=h:h.remove();else for(g in d)d[g].remove()}}}});
